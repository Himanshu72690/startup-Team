<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Application Tracker | StartupTeam</title>
  <script>
    (function(){
      // Immediate Auth Check on page load
      const user = JSON.parse(localStorage.getItem("loggedInUser"));
      const token = localStorage.getItem("token");
      if(!user || user.role !== "member" || !token){
        window.location.replace("login.html");
      }
      // Prevent back button access after logout
      window.addEventListener('popstate', function(event) {
        const userCheck = JSON.parse(localStorage.getItem("loggedInUser"));
        const tokenCheck = localStorage.getItem("token");
        if(!userCheck || userCheck.role !== "member" || !tokenCheck){
          window.location.replace("login.html");
        }
      });
    })();
  </script>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <script src="https://unpkg.com/lucide@latest"></script>
  <style>
    /* CORE THEME */
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: 'Poppins', sans-serif; background: #f8fafc; color: #1e293b; }
    
    @keyframes fadeInUp {
      from { opacity: 0; transform: translateY(15px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .app { display: flex; min-height: 100vh; }

    /* SIDEBAR (Locked as requested) */
    .sidebar { 
      width: 260px; min-width: 260px; background: #0f172a; color: #fff; 
      padding: 30px 20px; display: flex; flex-direction: column; 
      position: sticky; top: 0; height: 100vh; z-index: 1000;
      transition: width 0.3s ease;
    }
    .sidebar.collapsed {
      width: 80px; min-width: 80px; padding: 20px 10px;
    }
    .toggle-sidebar { background: none; border: none; color: #fff; cursor: pointer; font-size: 20px; margin-bottom: 30px; display: flex; align-items: center; justify-content: center; width: 40px; height: 40px; border-radius: 8px; transition: 0.3s; }
    .toggle-sidebar:hover { background: rgba(255,255,255,0.1); }
    .logo { font-size: 24px; font-weight: 700; margin-bottom: 40px; padding-left: 10px; white-space: nowrap; transition: 0.3s; }
    .sidebar.collapsed .logo { font-size: 0; margin-bottom: 20px; padding-left: 0; white-space: nowrap; }
    .logo span { color: #6366f1; }
    .sidebar nav { flex: 1; }
    .sidebar a { 
      display: flex; align-items: center; gap: 12px; color: #94a3b8; text-decoration: none; 
      padding: 12px 15px; border-radius: 10px; margin-bottom: 8px; transition: 0.3s; 
      font-size: 14px; font-weight: 500; white-space: nowrap;
    }
    .sidebar.collapsed a { padding: 12px; justify-content: center; gap: 0; }
    .sidebar.collapsed a span { display: none; }
    .sidebar a:hover { background: rgba(255,255,255,0.05); color: #fff; }
    .sidebar a.active { background: #6366f1; color: white !important; box-shadow: 0 4px 12px rgba(99, 102, 241, 0.3); }

    .logout-btn { 
      background: #ef4444; color: white; border: none; padding: 12px; border-radius: 10px; 
      cursor: pointer; display: flex; align-items: center; justify-content: center; 
      gap: 8px; font-weight: 600; transition: 0.3s; margin-top: auto; white-space: nowrap;
    }
    .sidebar.collapsed .logout-btn { gap: 0; }
    .sidebar.collapsed .logout-btn span { display: none; }

    /* MAIN CONTENT */
    .main { flex: 1; padding: 40px 60px; max-width: 1200px; }
    .header-section { margin-bottom: 30px; }
    .header-section h2 { font-size: 28px; font-weight: 700; color: #0f172a; }

    /* STATS GRID WITH ICONS */
    .stats-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px; margin-bottom: 35px; }
    
    .stat-card { 
      background: #fff; padding: 20px; border-radius: 16px; border: 1px solid #f1f5f9; 
      display: flex; align-items: flex-start; justify-content: space-between;
      transition: 0.3s;
    }
    .stat-content span { font-size: 13px; color: #64748b; font-weight: 500; }
    .stat-content h4 { font-size: 24px; font-weight: 700; color: #0f172a; margin-top: 4px; }
    
    .stat-icon {
      width: 40px; height: 40px; border-radius: 10px; display: flex; align-items: center; justify-content: center;
    }
    .icon-total { background: #eef2ff; color: #6366f1; }
    .icon-interview { background: #f0fdf4; color: #22c55e; }
    .icon-pending { background: #fff7ed; color: #f97316; }
    .icon-rejected { background: #fef2f2; color: #ef4444; }

    /* FILTER BAR */
    .filter-controls { display: flex; gap: 12px; margin-bottom: 25px; }
    .search-box { flex: 1; position: relative; display: flex; align-items: center; }
    .search-box i { position: absolute; left: 16px; color: #94a3b8; pointer-events: none; }
    .search-box input {
      width: 100%; height: 50px; padding: 0 20px 0 48px; border-radius: 12px;
      border: 1px solid #e2e8f0; background: #fff; font-family: inherit; font-size: 14px;
      outline: none; transition: 0.2s;
    }
    .search-box input:focus { border-color: #6366f1; box-shadow: 0 0 0 4px rgba(99, 102, 241, 0.05); }

    .status-select {
      height: 50px; min-width: 170px; padding: 0 15px; border-radius: 12px;
      border: 1px solid #e2e8f0; background: #fff; color: #475569; font-family: inherit;
      font-size: 14px; font-weight: 500; cursor: pointer; outline: none;
      appearance: none;
      background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 24 24' stroke='%2394a3b8' stroke-width='2'%3E%3Cpath stroke-linecap='round' stroke-linejoin='round' d='M19 9l-7 7-7-7'%3E%3C/path%3E%3C/svg%3E");
      background-repeat: no-repeat; background-position: right 15px center; background-size: 14px;
    }

    /* REQUEST LIST */
    .request-list { display: flex; flex-direction: column; gap: 15px; }
    .request-card { 
      background: #fff; padding: 20px 25px; border-radius: 18px; border: 1px solid #f1f5f9; 
      display: flex; justify-content: space-between; align-items: center;
      transition: 0.3s ease; animation: fadeInUp 0.4s ease-out forwards;
    }
    .request-card:hover { border-color: #6366f1; box-shadow: 0 10px 30px rgba(0,0,0,0.04); }

    .startup-info { display: flex; align-items: center; gap: 15px; }
    .startup-icon { width: 50px; height: 50px; border-radius: 12px; background: #eff6ff; color: #6366f1; display: flex; align-items: center; justify-content: center; font-size: 20px; font-weight: 700; border: 1px solid #dbeafe; }
    
    .text-details h3 { font-size: 16px; font-weight: 600; color: #0f172a; }
    .text-details p { font-size: 13px; color: #64748b; display: flex; align-items: center; gap: 5px; }

    /* ACTION AREA */
    .action-area { display: flex; align-items: center; gap: 20px; }
    .status-badge { padding: 6px 14px; border-radius: 100px; font-size: 11px; font-weight: 700; text-transform: uppercase; }
    .status-pending { background: #fff7ed; color: #f97316; }
    .status-interview { background: #f0fdf4; color: #22c55e; }
    .status-shortlisted { background: #f0fdf4; color: #22c55e; }
    .status-rejected { background: #fef2f2; color: #ef4444; }

    .delete-btn {
      color: #94a3b8; background: none; border: none; cursor: pointer; padding: 8px; border-radius: 8px; transition: 0.2s;
    }
    .delete-btn:hover { color: #ef4444; background: #fef2f2; }

    .empty-state { text-align: center; padding: 60px; color: #94a3b8; width: 100%; }

    /* TOAST NOTIFICATIONS */
    #notificationContainer {
      position: fixed; top: 20px; right: 20px; z-index: 9999; display: flex; flex-direction: column; gap: 10px;
    }
    .toast-notification {
      background: #fff; padding: 16px 20px; border-radius: 12px; border-left: 4px solid #6366f1;
      box-shadow: 0 8px 24px rgba(0, 0, 0, 0.12); min-width: 300px; max-width: 400px;
      color: #0f172a; font-weight: 500; animation: slideIn 0.3s ease-out;
    }
    .toast-notification.success {
      border-left-color: #22c55e; background: #f0fdf4; color: #166534;
    }
    .toast-notification.error {
      border-left-color: #ef4444; background: #fef2f2; color: #991b1b;
    }
    .toast-notification.info {
      border-left-color: #3b82f6; background: #eff6ff; color: #1e40af;
    }
    @keyframes slideIn {
      from { transform: translateX(400px); opacity: 0; }
      to { transform: translateX(0); opacity: 1; }
    }
    @keyframes slideOut {
      from { transform: translateX(0); opacity: 1; }
      to { transform: translateX(400px); opacity: 0; }
    }

    /* CONFIRMATION DIALOG */
    .modal-overlay {
      display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(0, 0, 0, 0.5); z-index: 9998; align-items: center; justify-content: center;
    }
    .modal-overlay.active {
      display: flex;
    }
    .confirmation-dialog {
      background: #fff; padding: 30px; border-radius: 16px; box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
      max-width: 400px; width: 90%; animation: slideDown 0.3s ease-out;
    }
    @keyframes slideDown {
      from { transform: translateY(-50px); opacity: 0; }
      to { transform: translateY(0); opacity: 1; }
    }
    .confirmation-dialog h3 {
      font-size: 18px; font-weight: 600; color: #0f172a; margin-bottom: 10px;
    }
    .confirmation-dialog p {
      font-size: 14px; color: #64748b; margin-bottom: 25px; line-height: 1.5;
    }
    .dialog-buttons {
      display: flex; gap: 12px; justify-content: flex-end;
    }
    .dialog-btn {
      padding: 10px 20px; border-radius: 8px; border: none; font-weight: 600; cursor: pointer;
      font-size: 13px; transition: 0.2s;
    }
    .dialog-btn.cancel {
      background: #f1f5f9; color: #475569;
    }
    .dialog-btn.cancel:hover {
      background: #e2e8f0;
    }
    .dialog-btn.confirm {
      background: #ef4444; color: #fff;
    }
    .dialog-btn.confirm:hover {
      background: #dc2626;
    }
  </style>
</head>
<body>

<div class="app">
  <aside class="sidebar">
    <button class="toggle-sidebar" onclick="toggleSidebar()"><i data-lucide="chevrons-left"></i></button>
    <div class="logo">Startup<span>Team</span></div>
    <nav>
      <a href="member-dashboard.html"><i data-lucide="layout-dashboard"></i> <span>Dashboard</span></a>
      <a href="posted-roles.html"><i data-lucide="users"></i> <span>Explore Opportunities</span></a>
      <a href="startup-details.html"><i data-lucide="search"></i> <span>Explore Dreams</span></a>
      <a href="join-requests.html" class="active"><i data-lucide="send"></i> <span>My Applications</span></a>
      <a href="my-profile.html"><i data-lucide="user"></i> <span>Profile</span></a>
    </nav>
    <button onclick="window.logoutUser()" class="logout-btn"><i data-lucide="log-out"></i> <span>Sign Out</span></button>
  </aside>

  <div id="notificationContainer"></div>
  <div class="modal-overlay" id="confirmationModal">
    <div class="confirmation-dialog">
      <h3>Cancel Application?</h3>
      <p>Are you sure you want to cancel this application? This action cannot be undone.</p>
      <div class="dialog-buttons">
        <button class="dialog-btn cancel" onclick="closeConfirmation()">Cancel</button>
        <button class="dialog-btn confirm" onclick="confirmDelete()">Yes, Cancel Application</button>
      </div>
    </div>
  </div>

  <main class="main">
    <div class="header-section">
      <h2>Application Tracker</h2>
      <p style="color: #64748b; font-size: 14px;">Track your journey with startups in real-time.</p>
    </div>

    <div class="stats-grid">
      <div class="stat-card">
        <div class="stat-content"><span>Total</span><h4 id="statTotal">0</h4></div>
        <div class="stat-icon icon-total"><i data-lucide="briefcase" size="20"></i></div>
      </div>
      <div class="stat-card">
        <div class="stat-content"><span>Pending</span><h4 id="statPending">0</h4></div>
        <div class="stat-icon icon-pending"><i data-lucide="clock" size="20"></i></div>
      </div>
      <div class="stat-card">
        <div class="stat-content"><span>Rejected</span><h4 id="statRejected">0</h4></div>
        <div class="stat-icon icon-rejected"><i data-lucide="user-x" size="20"></i></div>
      </div>
    </div>

    <div class="filter-controls">
      <div class="search-box">
        <i data-lucide="search" size="20"></i>
        <input type="text" id="searchInput" placeholder="Search startup or role..." onkeyup="filterData()">
      </div>
      <select id="statusFilter" class="status-select" onchange="filterData()">
        <option value="All">All Status</option>
        <option value="Interview">Interview</option>
        <option value="Pending">Pending</option>
        <option value="Rejected">Rejected</option>
      </select>
    </div>

    <div class="request-list" id="reqContainer"></div>
  </main>
</div>

<script>
  // Sidebar toggle functionality
  function toggleSidebar() {
    const sidebar = document.querySelector('.sidebar');
    const icon = document.querySelector('.toggle-sidebar i');
    sidebar.classList.toggle('collapsed');
    if (sidebar.classList.contains('collapsed')) {
      icon.setAttribute('data-lucide', 'chevrons-right');
      localStorage.setItem('sidebarCollapsed', 'true');
    } else {
      icon.setAttribute('data-lucide', 'chevrons-left');
      localStorage.setItem('sidebarCollapsed', 'false');
    }
    lucide.createIcons();
  }

  function restoreSidebarState() {
    const isCollapsed = localStorage.getItem('sidebarCollapsed') === 'true';
    const sidebar = document.querySelector('.sidebar');
    const icon = document.querySelector('.toggle-sidebar i');
    if (isCollapsed) {
      sidebar.classList.add('collapsed');
      icon.setAttribute('data-lucide', 'chevrons-right');
    } else {
      sidebar.classList.remove('collapsed');
      icon.setAttribute('data-lucide', 'chevrons-left');
    }
  }

  // Call restore before page fully loads
  restoreSidebarState();

  let allApplications = [];
  let pendingDeleteId = null;

  function showNotification(message, type = 'success', duration = 4000) {
    const container = document.getElementById('notificationContainer');
    const toast = document.createElement('div');
    toast.className = `toast-notification ${type}`;
    toast.textContent = message;
    container.appendChild(toast);

    setTimeout(() => {
      toast.style.animation = 'slideOut 0.3s ease-out forwards';
      setTimeout(() => toast.remove(), 300);
    }, duration);
  }

  async function loadRequests() {
    try {
      const token = localStorage.getItem('token') || localStorage.getItem('accessToken');
      
      if (!token) {
        console.error('No authentication token found');
        displayEmptyState();
        return;
      }

      const response = await fetch('http://localhost:5000/api/member/applications', {
        method: 'GET',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': `Bearer ${token}`
        }
      });

      if (!response.ok) {
        throw new Error(`Failed to fetch applications: ${response.status}`);
      }

      const data = await response.json();
      const applications = data.data || [];

      // Map backend data to display format
      allApplications = applications.map(app => {
        const roleInfo = app.roleId || {};
        const startupInfo = app.startupId || {};
        const backendStatus = app.status || 'pending';
        
        return {
          id: app._id || app.id,
          startup: startupInfo.companyName || startupInfo.name || 'Unknown Startup',
          role: roleInfo.title || 'Unknown Role',
          date: formatDate(app.createdAt || app.appliedDate),
          status: capitalizeStatus(backendStatus),
          rawStatus: backendStatus,
          statusClass: getStatusClass(backendStatus)
        };
      });

      updateStats();
      renderData(allApplications);
    } catch (error) {
      console.error('Error loading applications:', error);
      displayEmptyState('Unable to load applications. Please try again later.');
    }
  }

  function formatDate(dateString) {
    if (!dateString) return 'Unknown';
    const date = new Date(dateString);
    const day = String(date.getDate()).padStart(2, '0');
    const month = String(date.getMonth() + 1).padStart(2, '0');
    const year = date.getFullYear();
    return `${day} ${getMonthName(date.getMonth())} ${year}`;
  }

  function getMonthName(monthIndex) {
    const months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
    return months[monthIndex];
  }

  function capitalizeStatus(status) {
    if (!status) return 'Pending';
    const statusMap = {
      'pending': 'Pending',
      'shortlisted': 'Interview',
      'interviewing': 'Interview',
      'rejected': 'Rejected',
      'interview': 'Interview'
    };
    return statusMap[status.toLowerCase()] || status.charAt(0).toUpperCase() + status.slice(1).toLowerCase();
  }

  function getStatusClass(status) {
    const statusClassMap = {
      'pending': 'pending',
      'shortlisted': 'interview',
      'interviewing': 'interview',
      'rejected': 'rejected',
      'interview': 'interview'
    };
    return statusClassMap[status.toLowerCase()] || 'pending';
  }

  function displayEmptyState(message = 'No applications found.') {
    const container = document.getElementById('reqContainer');
    container.innerHTML = `
      <div class="empty-state">
        <i data-lucide="search-x" size="48" style="margin-bottom:15px; color:#cbd5e1"></i>
        <p>${message}</p>
      </div>`;
    lucide.createIcons();
  }

  function updateStats() {
    document.getElementById('statTotal').innerText = allApplications.length;
    document.getElementById('statPending').innerText = allApplications.filter(a => a.rawStatus === 'pending').length;
    document.getElementById('statRejected').innerText = allApplications.filter(a => a.rawStatus === 'rejected').length;
  }

  function renderData(data) {
    const container = document.getElementById('reqContainer');
    if(data.length === 0) {
      displayEmptyState('No applications found matching your criteria.');
      return;
    }

    container.innerHTML = data.map((req, index) => `
      <div class="request-card" style="animation-delay: ${index * 0.05}s">
        <div class="startup-info">
          <div class="startup-icon">${req.startup.charAt(0).toUpperCase()}</div>
          <div class="text-details">
            <h3>${req.startup}</h3>
            <p><i data-lucide="calendar" size="12"></i> Applied on ${req.date} â€¢ ${req.role}</p>
          </div>
        </div>
        <div class="action-area">
          <span class="status-badge status-${req.statusClass}">${req.status}</span>
          <button class="delete-btn" onclick="deleteApp('${req.id}')" title="Cancel Application">
            <i data-lucide="trash-2" size="18"></i>
          </button>
        </div>
      </div>
    `).join('');
    lucide.createIcons();
  }

  function deleteApp(id) {
    pendingDeleteId = id;
    document.getElementById('confirmationModal').classList.add('active');
  }

  function closeConfirmation() {
    document.getElementById('confirmationModal').classList.remove('active');
    pendingDeleteId = null;
  }

  async function confirmDelete() {
    if (!pendingDeleteId) return;

    const id = pendingDeleteId;
    closeConfirmation();

    try {
      const token = localStorage.getItem('token') || localStorage.getItem('accessToken');
      
      if (!token) {
        showNotification('Authentication error. Please log in again.', 'error');
        return;
      }

      const response = await fetch(`http://localhost:5000/api/member/applications/${id}`, {
        method: 'DELETE',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': `Bearer ${token}`
        }
      });

      if (response.ok) {
        // Remove from local array
        allApplications = allApplications.filter(app => app.id !== id);
        updateStats();
        filterData();
        showNotification('Application cancelled successfully', 'success');
      } else {
        showNotification('Failed to cancel application', 'error');
      }
    } catch (error) {
      console.error('Error deleting application:', error);
      showNotification('Error canceling application', 'error');
    }
  }

  function filterData() {
    const searchTerm = document.getElementById('searchInput').value.toLowerCase();
    const statusTerm = document.getElementById('statusFilter').value;

    const filtered = allApplications.filter(req => {
      const matchesSearch = req.startup.toLowerCase().includes(searchTerm) || 
                            req.role.toLowerCase().includes(searchTerm);
      const matchesStatus = (statusTerm === "All") || (req.status === statusTerm);
      return matchesSearch && matchesStatus;
    });

    if (filtered.length === 0) {
      displayEmptyState('No applications match your search criteria.');
    } else {
      renderData(filtered);
    }
  }

  window.onload = loadRequests;
</script>
<script src="../assets/js/logout.js"></script>
</body>
</html>