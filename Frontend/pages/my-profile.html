<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Professional Profile | StartupTeam</title>
  <script>
    (function(){
      // Immediate Auth Check on page load
      const user = JSON.parse(localStorage.getItem("loggedInUser"));
      const token = localStorage.getItem("token");
      if(!user || user.role !== "member" || !token){
        window.location.replace("login.html");
      }
      // Prevent back button access after logout
      window.addEventListener('popstate', function(event) {
        const userCheck = JSON.parse(localStorage.getItem("loggedInUser"));
        const tokenCheck = localStorage.getItem("token");
        if(!userCheck || userCheck.role !== "member" || !tokenCheck){
          window.location.replace("login.html");
        }
      });
    })();
  </script>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <script src="https://unpkg.com/lucide@latest"></script>
  <style>

    
    /* CORE THEME */
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: 'Poppins', sans-serif; background: #f8fafc; color: #1e293b; }
    .app { display: flex; min-height: 100vh; }

    /* MODERN SIDEBAR (Same as Application Tracker) */
    .sidebar { width: 260px; background: #0f172a; color: #fff; padding: 30px 20px; display: flex; flex-direction: column; position: sticky; top: 0; height: 100vh; transition: width 0.3s ease; }
    .sidebar.collapsed { width: 80px; padding: 20px 10px; }
    .toggle-sidebar { background: none; border: none; color: #fff; cursor: pointer; font-size: 20px; margin-bottom: 30px; display: flex; align-items: center; justify-content: center; width: 40px; height: 40px; border-radius: 8px; transition: 0.3s; }
    .toggle-sidebar:hover { background: rgba(255,255,255,0.1); }
    .logo { font-size: 24px; font-weight: 700; margin-bottom: 40px; padding-left: 10px; transition: 0.3s; }
    .sidebar.collapsed .logo { font-size: 0; margin-bottom: 20px; padding-left: 0; }
    .logo span { color: #6366f1; }
    .sidebar nav { flex: 1; }
    .sidebar a { display: flex; align-items: center; gap: 12px; color: #94a3b8; text-decoration: none; padding: 12px 15px; border-radius: 10px; margin-bottom: 8px; transition: 0.3s; font-size: 14px; font-weight: 500; white-space: nowrap; }
    .sidebar.collapsed a { padding: 12px; justify-content: center; gap: 0; }
    .sidebar.collapsed a span { display: none; }
    .sidebar a:hover { background: rgba(255,255,255,0.05); color: #fff; }
    .sidebar a.active { background: #6366f1; color: white; box-shadow: 0 4px 12px rgba(99, 102, 241, 0.3); }

    /* NEW LOGOUT BUTTON STYLE */
    .logout-btn { background: #ef4444; color: white; border: none; padding: 12px; border-radius: 10px; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 8px; font-weight: 600; transition: 0.3s; margin-top: auto; white-space: nowrap; }
    .sidebar.collapsed .logout-btn { gap: 0; }
    .sidebar.collapsed .logout-btn span { display: none; }
    .logout-btn:hover { background: #dc2626; transform: translateY(-2px); }

    /* MAIN CONTENT */
    .main { flex: 1; padding: 40px 60px; max-width: 1100px; }

    /* PROFILE UI COMPONENTS */
    .profile-card { background: #fff; border-radius: 20px; border: 1px solid #f1f5f9; padding: 30px; margin-bottom: 25px; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.02); }
    .profile-header { display: flex; justify-content: space-between; align-items: center; }
    .user-meta { display: flex; align-items: center; gap: 20px; }
    .avatar-box { width: 80px; height: 80px; border-radius: 16px; background: #6366f1; color: #fff; display: flex; align-items: center; justify-content: center; font-size: 32px; font-weight: 700; }
    .user-info h1 { font-size: 26px; font-weight: 700; color: #0f172a; }
    .user-info p { color: #6366f1; font-weight: 600; font-size: 14px; }

    .btn-edit { background: #6366f1; color: #fff; padding: 10px 20px; border-radius: 10px; text-decoration: none; font-weight: 600; font-size: 13px; display: flex; align-items: center; gap: 8px; transition: 0.3s; }
    .btn-edit:hover { background: #4f46e5; transform: scale(1.05); }

    .details-grid { display: grid; grid-template-columns: 2fr 1fr; gap: 25px; }
    .info-box { background: #fff; padding: 25px; border-radius: 20px; border: 1px solid #f1f5f9; margin-bottom: 25px; transition: 0.3s; }
    .info-box:hover { transform: translateY(-5px); border-color: #6366f1; box-shadow: 0 10px 25px rgba(0,0,0,0.05); }
    
    .label-title { font-size: 11px; font-weight: 800; color: #94a3b8; text-transform: uppercase; letter-spacing: 1px; margin-bottom: 15px; display: flex; align-items: center; gap: 8px; }
    .label-title i { color: #6366f1; }

    .bio-text { line-height: 1.8; color: #475569; font-size: 15px; }
    .exp-item { display: flex; gap: 15px; background: #f0fdf4; padding: 15px; border-radius: 12px; border: 1px solid #dcfce7; }
    .exp-content h4 { font-size: 15px; color: #166534; }
    .exp-content p { font-size: 13px; color: #166534; opacity: 0.8; }

    .skills-flex { display: flex; flex-wrap: wrap; gap: 8px; }
    .skill-tag { background: #eff6ff; color: #3b82f6; padding: 5px 12px; border-radius: 8px; font-size: 12px; font-weight: 700; border: 1px solid #dbeafe; transition: 0.2s; }
    .skill-tag:hover { background: #6366f1; color: #fff; transform: scale(1.1); }

    .social-links a { display: flex; align-items: center; gap: 12px; padding: 12px; background: #f8fafc; border-radius: 12px; text-decoration: none; color: #1e293b; font-size: 14px; font-weight: 600; margin-bottom: 10px; border: 1px solid #eef2f6; transition: 0.2s; }
    .social-links a:hover { border-color: #6366f1; color: #6366f1; padding-left: 18px; }

    /* PORTFOLIO PREVIEW */
    .portfolio-preview { display: flex; align-items: center; gap: 15px; background: #f0fdf4; padding: 15px; border-radius: 12px; border: 1px solid #dcfce7; }
    .portfolio-icon { width: 50px; height: 50px; border-radius: 10px; background: #22c55e; color: white; display: flex; align-items: center; justify-content: center; font-size: 24px; flex-shrink: 0; }
    .portfolio-info-text { flex: 1; }
    .portfolio-info-text p { font-size: 13px; color: #166534; margin: 2px 0; }
    .portfolio-info-text strong { color: #166534; font-weight: 600; }
    .portfolio-download-btn { background: #22c55e; color: white; border: none; padding: 8px 15px; border-radius: 8px; cursor: pointer; font-size: 12px; font-weight: 600; transition: 0.2s; text-decoration: none; display: flex; align-items: center; gap: 6px; }
    .portfolio-download-btn:hover { background: #16a34a; transform: translateY(-2px); }
    .portfolio-empty { text-align: center; padding: 20px; color: #94a3b8; font-size: 13px; }
  </style>
</head>
<body>

<div class="app">
  <aside class="sidebar">
    <button class="toggle-sidebar" onclick="toggleSidebar()"><i data-lucide="chevrons-left"></i></button>
    <div class="logo">Startup<span>Team</span></div>
    <nav>
      <a href="member-dashboard.html"><i data-lucide="layout-dashboard"></i> <span>Dashboard</span></a>
      <a href="posted-roles.html"><i data-lucide="users"></i> <span>Explore Opportunities</span></a>
      <a href="startup-details.html"><i data-lucide="search"></i> <span>Explore Dreams</span></a>
      <a href="join-requests.html"><i data-lucide="send"></i> <span>My Applications</span></a>
      <a href="my-profile.html" class="active"><i data-lucide="user"></i> <span>Profile</span></a>
    </nav>
    <button onclick="window.logoutUser()" class="logout-btn"><i data-lucide="log-out"></i> <span>Log Out</span></button>
  </aside>

  <main class="main">
    <div class="profile-card">
      <div class="profile-header">
        <div class="user-meta">
          <div class="avatar-box" id="dispInit">M</div>
          <div class="user-info">
            <h1 id="dispName">User Name</h1>
            <p id="dispRole">Professional Role</p>
          </div>
        </div>
        <a href="edit-profile.html" class="btn-edit"><i data-lucide="edit-3" size="16"></i> Edit Profile</a>
      </div>
    </div>

    <div class="details-grid">
      <div class="left-col">
        <div class="info-box">
          <div class="label-title"><i data-lucide="book-open" size="14"></i> About My Journey</div>
          <p class="bio-text" id="dispBio">Your bio will show here.</p>
        </div>

        <div class="info-box">
          <div class="label-title"><i data-lucide="briefcase" size="14"></i> Experience Details</div>
          <div class="exp-item">
            <i data-lucide="award" class="exp-icon" style="color: #22c55e"></i>
            <div class="exp-content">
              <h4 id="dispExpHeading">0 Years of Experience</h4>
              <p id="dispCompany">Company: Not Specified</p>
            </div>
          </div>
        </div>

        <div class="info-box">
          <div class="label-title"><i data-lucide="mail" size="14"></i> Contact Information</div>
          <p style="font-size: 14px; font-weight: 600;" id="dispEmail">email@example.com</p>
        </div>

        <div class="info-box">
          <div class="label-title"><i data-lucide="file" size="14"></i> My Portfolio</div>
          <div id="portfolioPreview"></div>
        </div>
      </div>

      <div class="right-col">
        <div class="info-box">
          <div class="label-title"><i data-lucide="zap" size="14"></i> Tech Stack</div>
          <div class="skills-flex" id="dispSkills"></div>
        </div>

        <div class="info-box">
          <div class="label-title"><i data-lucide="link" size="14"></i> Online Presence</div>
          <div class="social-links">
            <a href="#" id="linkIn" target="_blank"><i data-lucide="linkedin" size="16"></i> LinkedIn</a>
            <a href="#" id="linkGh" target="_blank"><i data-lucide="github" size="16"></i> GitHub</a>
          </div>
        </div>
      </div>
    </div>
  </main>
</div>

<script>
  // Sidebar toggle functionality
  function toggleSidebar() {
    const sidebar = document.querySelector('.sidebar');
    const icon = document.querySelector('.toggle-sidebar i');
    sidebar.classList.toggle('collapsed');
    if (sidebar.classList.contains('collapsed')) {
      icon.setAttribute('data-lucide', 'chevrons-right');
      localStorage.setItem('sidebarCollapsed', 'true');
    } else {
      icon.setAttribute('data-lucide', 'chevrons-left');
      localStorage.setItem('sidebarCollapsed', 'false');
    }
    lucide.createIcons();
  }

  function restoreSidebarState() {
    const isCollapsed = localStorage.getItem('sidebarCollapsed') === 'true';
    const sidebar = document.querySelector('.sidebar');
    const icon = document.querySelector('.toggle-sidebar i');
    if (isCollapsed) {
      sidebar.classList.add('collapsed');
      icon.setAttribute('data-lucide', 'chevrons-right');
    } else {
      sidebar.classList.remove('collapsed');
      icon.setAttribute('data-lucide', 'chevrons-left');
    }
  }

  // Call restore before page fully loads
  restoreSidebarState();

  lucide.createIcons();

  async function loadProfile() {
    try {
      const token = localStorage.getItem('token') || localStorage.getItem('accessToken');

      if (!token) {
        console.error('No authentication token found');
        loadFallbackProfile();
        return;
      }

      // Get logged-in user basic info
      const loggedInUserStr = localStorage.getItem('loggedInUser') || localStorage.getItem('user');
      let loggedInUser = {};
      
      if (loggedInUserStr) {
        try {
          loggedInUser = JSON.parse(loggedInUserStr);
        } catch (e) {
          console.error('Error parsing logged-in user data:', e);
        }
      }

      // Fetch member profile from backend with cache busting
      const response = await fetch(`http://localhost:5000/api/member/profile?t=${Date.now()}`, {
        method: 'GET',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': `Bearer ${token}`
        }
      });

      let profileData = loggedInUser;

      if (response.ok) {
        const result = await response.json();
        const backendData = result.data || result;
        // Merge backend data with logged-in user info
        profileData = { ...loggedInUser, ...backendData };
      } else {
        console.warn('Could not fetch extended profile data, using basic user info');
      }

      // Display profile data
      displayProfile(profileData);
    } catch (error) {
      console.error('Error loading profile:', error);
      loadFallbackProfile();
    }
  }

  function displayProfile(data) {
    const name = data.name || data.fullName || 'User Name';
    const role = data.role || data.designation || 'Professional Role';
    const bio = data.bio || data.about || 'Update your bio to attract founders.';
    const email = data.email || 'email@example.com';
    const company = data.company || data.currentCompany || 'Freelance';
    const experience = data.yearsOfExperience || data.experience || data.exp || '0';
    const skills = data.skills || data.techStack || 'General';
    const linkedin = data.linkedin || data.linkedinUrl || '';
    const github = data.github || data.githubUrl || '';
    const portfolio = data.portfolio || data.portfolioUrl || '';

    document.getElementById('dispName').innerText = name;
    document.getElementById('dispInit').innerText = name.charAt(0).toUpperCase();
    document.getElementById('dispRole').innerText = role;
    document.getElementById('dispBio').innerText = bio;
    document.getElementById('dispEmail').innerText = email;
    document.getElementById('dispExpHeading').innerText = `${experience} Years Experience`;
    document.getElementById('dispCompany').innerText = `Current @ ${company}`;

    if (linkedin) document.getElementById('linkIn').href = linkedin;
    if (github) document.getElementById('linkGh').href = github;
    
    // Handle portfolio file preview
    const portfolioPreviewContainer = document.getElementById('portfolioPreview');
    
    // If portfolio is null or empty, clear localStorage file data and show empty state
    if (!portfolio || (typeof portfolio === 'object' && Object.keys(portfolio).length === 0)) {
      localStorage.removeItem('portfolioFile');
      portfolioPreviewContainer.innerHTML = `
        <div class="portfolio-empty">
          <p style="margin: 10px 0;">No portfolio uploaded yet</p>
          <p style="font-size: 12px; opacity: 0.7;">Upload PDF or Word documents in your profile settings</p>
        </div>
      `;
    } else if (portfolio && typeof portfolio === 'object' && portfolio.filename) {
      // We have portfolio metadata from backend
      let fileName = portfolio.filename;
      const fileExt = fileName.split('.').pop().toLowerCase();
      const isPDF = fileExt === 'pdf';
      const isWord = ['doc', 'docx'].includes(fileExt);
      
      let icon = 'ðŸ“„';
      if (isPDF) {
        icon = 'ðŸ“•';
      } else if (isWord) {
        icon = 'ðŸ“˜';
      }
      
      // Try to get the actual file data from localStorage
      const storedFile = localStorage.getItem('portfolioFile');
      let downloadUrl = '';
      
      if (storedFile) {
        try {
          const fileData = JSON.parse(storedFile);
          if (fileData && fileData.filedata) {
            downloadUrl = fileData.filedata;
          }
        } catch (e) {
          console.warn('Could not parse stored portfolio file:', e);
        }
      }
      
      portfolioPreviewContainer.innerHTML = `
        <div class="portfolio-preview">
          <div class="portfolio-icon">${icon}</div>
          <div class="portfolio-info-text">
            <strong>${fileName}</strong>
            <p>${isPDF ? 'PDF Document' : 'Word Document'}</p>
          </div>
          <button class="portfolio-download-btn" id="downloadPortfolioBtn" title="Download Portfolio" style="border: none; background: #22c55e; color: white; padding: 8px 15px; border-radius: 8px; cursor: pointer; font-size: 12px; font-weight: 600; transition: 0.2s; display: flex; align-items: center; gap: 6px;">
            <i data-lucide="download" size="14"></i> Download
          </button>
        </div>
      `;
      
      // Set up download button handler
      const downloadBtn = document.getElementById('downloadPortfolioBtn');
      if (downloadBtn && downloadUrl) {
        downloadBtn.onclick = function(e) {
          e.preventDefault();
          const link = document.createElement('a');
          link.href = downloadUrl;
          link.download = fileName;
          document.body.appendChild(link);
          link.click();
          document.body.removeChild(link);
        };
      } else if (downloadBtn) {
        downloadBtn.style.opacity = '0.6';
        downloadBtn.style.cursor = 'not-allowed';
        downloadBtn.title = 'Portfolio data not available';
      }
      
      // Re-initialize Lucide icons
      if (window.lucide) {
        lucide.createIcons();
      }
    } else {
      portfolioPreviewContainer.innerHTML = `
        <div class="portfolio-empty">
          <p style="margin: 10px 0;">No portfolio uploaded yet</p>
          <p style="font-size: 12px; opacity: 0.7;">Upload PDF or Word documents in your profile settings</p>
        </div>
      `;
    }

    const skillsArray = Array.isArray(skills) ? skills : skills.split(',');
    document.getElementById('dispSkills').innerHTML = skillsArray
      .map(s => `<span class="skill-tag">${typeof s === 'string' ? s.trim() : s}</span>`)
      .join('');

    lucide.createIcons();
  }

  function loadFallbackProfile() {
    const data = JSON.parse(localStorage.getItem("memberProfile")) || {
      name: "User Name",
      role: "Professional Role",
      bio: "Add your bio in edit profile.",
      email: "email@example.com",
      company: "Freelance",
      exp: "0",
      skills: "General"
    };
    displayProfile(data);
  }

  window.onload = loadProfile;
</script>
<script src="../assets/js/logout.js"></script>
</body>
</html>