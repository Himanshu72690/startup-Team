<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Edit Profile | StartupTeam</title>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <script src="https://unpkg.com/lucide@latest"></script>
  <style>
    /* CORE THEME */
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Poppins', sans-serif;
      background: #f8fafc;
      color: #1e293b;
    }

    .app {
      display: flex;
      min-height: 100vh;
    }

    /* SIDEBAR */
    .sidebar {
      width: 260px;
      background: #0f172a;
      color: #fff;
      padding: 30px 20px;
      display: flex;
      flex-direction: column;
      position: sticky;
      top: 0;
      height: 100vh;
      transition: width 0.3s ease;
    }

    .sidebar.collapsed {
      width: 80px;
      padding: 20px 10px;
    }

    .toggle-sidebar {
      background: none;
      border: none;
      color: #fff;
      cursor: pointer;
      font-size: 20px;
      margin-bottom: 30px;
      display: flex;
      align-items: center;
      justify-content: center;
      width: 40px;
      height: 40px;
      border-radius: 8px;
      transition: 0.3s;
    }

    .toggle-sidebar:hover {
      background: rgba(255, 255, 255, 0.1);
    }

    .logo {
      font-size: 24px;
      font-weight: 700;
      margin-bottom: 40px;
      padding-left: 10px;
      transition: 0.3s;
    }

    .sidebar.collapsed .logo {
      font-size: 0;
      margin-bottom: 20px;
      padding-left: 0;
    }

    .logo span {
      color: #6366f1;
    }

    .sidebar a {
      display: flex;
      align-items: center;
      gap: 12px;
      color: #94a3b8;
      text-decoration: none;
      padding: 12px 15px;
      border-radius: 8px;
      margin-bottom: 5px;
      transition: 0.3s;
      font-size: 14px;
      white-space: nowrap;
    }

    .sidebar.collapsed a {
      padding: 12px;
      justify-content: center;
      gap: 0;
    }

    .sidebar.collapsed a span {
      display: none;
    }

    .sidebar a.active {
      background: #6366f1;
      color: white;
    }

    .logout-btn {
      margin-top: auto;
      background: #ef4444;
      color: white;
      border: none;
      padding: 12px;
      border-radius: 8px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      font-weight: 600;
      white-space: nowrap;
      transition: 0.3s;
    }

    .sidebar.collapsed .logout-btn {
      gap: 0;
    }

    .sidebar.collapsed .logout-btn span {
      display: none;
    }

    .logout-btn:hover {
      background: #dc2626;
    }

    /* MAIN CONTENT */
    .main {
      flex: 1;
      padding: 40px;
    }

    .header-section {
      margin-bottom: 30px;
    }

    .header-section h2 {
      font-size: 28px;
      font-weight: 700;
    }

    /* FORM STYLING */
    .edit-card {
      background: #fff;
      padding: 40px;
      border-radius: 20px;
      border: 1px solid #f1f5f9;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.02);
      max-width: 900px;
    }

    .section-label {
      font-size: 13px;
      font-weight: 700;
      color: #6366f1;
      margin: 30px 0 20px;
      display: flex;
      align-items: center;
      gap: 10px;
      text-transform: uppercase;
      letter-spacing: 1px;
    }

    .section-label:first-child {
      margin-top: 0;
    }

    .form-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 20px;
    }

    .full-width {
      grid-column: span 2;
    }

    .input-group {
      margin-bottom: 10px;
    }

    .input-group label {
      display: block;
      font-size: 12px;
      font-weight: 600;
      color: #64748b;
      margin-bottom: 8px;
    }

    .input-wrapper {
      position: relative;
      display: flex;
      align-items: center;
    }

    .icon-box {
      position: absolute;
      left: 12px;
      width: 34px;
      height: 34px;
      border-radius: 8px;
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1;
    }

    /* ICON COLORS */
    .bg-blue {
      background: #eff6ff;
      color: #3b82f6;
    }

    .bg-purple {
      background: #f5f3ff;
      color: #8b5cf6;
    }

    .bg-gray {
      background: #f1f5f9;
      color: #475569;
    }

    .bg-orange {
      background: #fff7ed;
      color: #f97316;
    }

    .bg-green {
      background: #f0fdf4;
      color: #22c55e;
    }

    .input-wrapper input,
    .input-wrapper textarea {
      width: 100%;
      padding: 12px 15px 12px 55px;
      border: 1px solid #e2e8f0;
      border-radius: 10px;
      font-size: 14px;
      outline: none;
      transition: 0.3s;
      font-family: inherit;
    }

    .input-wrapper input:focus,
    .input-wrapper textarea:focus {
      border-color: #6366f1;
      box-shadow: 0 0 0 4px rgba(99, 102, 241, 0.1);
    }

    .save-btn {
      margin-top: 40px;
      background: #6366f1;
      color: white;
      padding: 15px 30px;
      border-radius: 12px;
      border: none;
      font-weight: 700;
      font-size: 15px;
      cursor: pointer;
      width: 100%;
      transition: 0.3s;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
      box-shadow: 0 10px 15px -3px rgba(99, 102, 241, 0.3);
    }

    .save-btn:hover {
      background: #4f46e5;
      transform: translateY(-2px);
    }

    /* TOAST NOTIFICATIONS */
    #notificationContainer {
      position: fixed;
      top: 20px;
      right: 20px;
      z-index: 9999;
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .toast-notification {
      background: #fff;
      padding: 16px 20px;
      border-radius: 12px;
      border-left: 4px solid #6366f1;
      box-shadow: 0 8px 24px rgba(0, 0, 0, 0.12);
      min-width: 300px;
      max-width: 400px;
      color: #0f172a;
      font-weight: 500;
      animation: slideIn 0.3s ease-out;
    }

    .toast-notification.success {
      border-left-color: #22c55e;
      background: #f0fdf4;
      color: #166534;
    }

    .toast-notification.error {
      border-left-color: #ef4444;
      background: #fef2f2;
      color: #991b1b;
    }

    @keyframes slideIn {
      from {
        transform: translateX(400px);
        opacity: 0;
      }

      to {
        transform: translateX(0);
        opacity: 1;
      }
    }

    @keyframes slideOut {
      from {
        transform: translateX(0);
        opacity: 1;
      }

      to {
        transform: translateX(400px);
        opacity: 0;
      }
    }

    /* PORTFOLIO DELETE BUTTON */
    .portfolio-info {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 10px;
    }

    .delete-portfolio-btn {
      background: #ef4444;
      color: white;
      border: none;
      padding: 6px 12px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 11px;
      font-weight: 600;
      transition: 0.2s;
    }

    .delete-portfolio-btn:hover {
      background: #dc2626;
    }
  </style>
</head>

<body>

  <div class="app">
    <aside class="sidebar">
      <button class="toggle-sidebar" onclick="toggleSidebar()"><i data-lucide="chevrons-left"></i></button>
      <div class="logo">Startup<span>Team</span></div>
      <nav>
        <a href="member-dashboard.html"><i data-lucide="layout-dashboard"></i> <span>Dashboard</span></a>
        <a href="posted-roles.html"><i data-lucide="users"></i> <span>Explore Opportunities</span></a>
        <a href="startup-details.html"><i data-lucide="search"></i> <span>Explore Dreams</span></a>
        <a href="join-requests.html"><i data-lucide="send"></i> <span>My Applications</span></a>
        <a href="my-profile.html" class="active"><i data-lucide="user"></i> <span>Profile</span></a>
      </nav>
      <button onclick="window.logoutUser()" class="logout-btn"><i data-lucide="log-out"></i>
        <span>Logout</span></button>
    </aside>

    <div id="notificationContainer"></div>

    <main class="main">
      <div class="header-section">
        <h2>Professional Experience</h2>
        <p style="color: #64748b; font-size: 14px;">Founders look for relevant experience before hiring.</p>
      </div>

      <div class="edit-card">
        <form id="memberProfileForm">
          <div class="section-label"><i data-lucide="user"></i> Basic Information</div>
          <div class="form-grid">
            <div class="input-group"><label>Full Name</label>
              <div class="input-wrapper">
                <div class="icon-box bg-blue"><i data-lucide="user-circle" size="18"></i></div><input type="text"
                  id="mName">
              </div>
            </div>
            <div class="input-group"><label>Professional Email</label>
              <div class="input-wrapper">
                <div class="icon-box bg-blue"><i data-lucide="mail" size="18"></i></div><input type="email" id="mEmail">
              </div>
            </div>
          </div>

          <div class="section-label"><i data-lucide="briefcase"></i> Work Experience</div>
          <div class="form-grid">
            <div class="input-group">
              <label>Current Role</label>
              <div class="input-wrapper">
                <div class="icon-box bg-green"><i data-lucide="user-plus" size="18"></i></div>
                <input type="text" id="mRole" placeholder="e.g. Senior Web Developer">
              </div>
            </div>
            <div class="input-group">
              <label>Current Company</label>
              <div class="input-wrapper">
                <div class="icon-box bg-green"><i data-lucide="building-2" size="18"></i></div>
                <input type="text" id="mCompany" placeholder="e.g. Google / Freelance">
              </div>
            </div>
            <div class="input-group full-width">
              <label>Years of Experience</label>
              <div class="input-wrapper">
                <div class="icon-box bg-green"><i data-lucide="calendar" size="18"></i></div>
                <input type="number" id="mExp" placeholder="e.g. 3">
              </div>
            </div>

            <div class="input-group full-width">
              <label>Professional Bio</label>
              <div class="input-wrapper">
                <div class="icon-box bg-blue"><i data-lucide="book-open" size="18"></i></div>
                <textarea id="mBio" style="resize: vertical; min-height: 100px;"
                  placeholder="Write about your professional background and skills..."></textarea>
              </div>
            </div>
          </div>

          <div class="section-label"><i data-lucide="share-2"></i> Social & Portfolios</div>
          <div class="form-grid">
            <div class="input-group"><label>LinkedIn</label>
              <div class="input-wrapper">
                <div class="icon-box bg-purple"><i data-lucide="linkedin" size="18"></i></div><input type="url"
                  id="mLinkedin">
              </div>
            </div>
            <div class="input-group"><label>GitHub</label>
              <div class="input-wrapper">
                <div class="icon-box bg-gray"><i data-lucide="github" size="18"></i></div><input type="text"
                  id="mGithub">
              </div>
            </div>
            <div class="input-group full-width"><label>Portfolio (PDF/Word Documents)</label>
              <div class="input-wrapper">
                <div class="icon-box bg-blue"><i data-lucide="file" size="18"></i></div><input type="file"
                  id="mPortfolio" accept=".pdf,.doc,.docx">
              </div>
            </div>
            <small style="grid-column: span 2; color: #94a3b8; margin-top: -5px;">Upload PDF or Word document (.pdf,
              .doc, .docx)</small>
          </div>

          <div class="section-label"><i data-lucide="award"></i> Expertise</div>
          <div class="form-grid">
            <div class="input-group full-width"><label>Skills</label>
              <div class="input-wrapper">
                <div class="icon-box bg-purple"><i data-lucide="cpu" size="18"></i></div><input type="text"
                  id="mSkills">
              </div>
            </div>
          </div>

          <button type="submit" class="save-btn"><i data-lucide="save" size="20"></i> Update Professional
            Profile</button>
        </form>
      </div>
    </main>
  </div>

  <script>
    // Sidebar toggle functionality
    function toggleSidebar() {
      const sidebar = document.querySelector('.sidebar');
      const icon = document.querySelector('.toggle-sidebar i');
      sidebar.classList.toggle('collapsed');
      if (sidebar.classList.contains('collapsed')) {
        icon.setAttribute('data-lucide', 'chevrons-right');
        localStorage.setItem('sidebarCollapsed', 'true');
      } else {
        icon.setAttribute('data-lucide', 'chevrons-left');
        localStorage.setItem('sidebarCollapsed', 'false');
      }
      lucide.createIcons();
    }

    function restoreSidebarState() {
      const isCollapsed = localStorage.getItem('sidebarCollapsed') === 'true';
      const sidebar = document.querySelector('.sidebar');
      const icon = document.querySelector('.toggle-sidebar i');
      if (isCollapsed) {
        sidebar.classList.add('collapsed');
        icon.setAttribute('data-lucide', 'chevrons-right');
      } else {
        sidebar.classList.remove('collapsed');
        icon.setAttribute('data-lucide', 'chevrons-left');
      }
    }

    // Call restore before page fully loads
    restoreSidebarState();

    lucide.createIcons();

    function showNotification(message, type = 'success', duration = 4000) {
      const container = document.getElementById('notificationContainer');
      const toast = document.createElement('div');
      toast.className = `toast-notification ${type}`;
      toast.textContent = message;
      container.appendChild(toast);

      setTimeout(() => {
        toast.style.animation = 'slideOut 0.3s ease-out forwards';
        setTimeout(() => toast.remove(), 300);
      }, duration);
    }

    async function loadProfile() {
      try {
        const token = localStorage.getItem('token') || localStorage.getItem('accessToken');

        if (!token) {
          console.error('No authentication token found');
          loadFallbackProfile();
          return;
        }

        // Get logged-in user basic info
        const loggedInUserStr = localStorage.getItem('loggedInUser') || localStorage.getItem('user');
        let loggedInUser = {};

        if (loggedInUserStr) {
          try {
            loggedInUser = JSON.parse(loggedInUserStr);
          } catch (e) {
            console.error('Error parsing logged-in user data:', e);
          }
        }

        // Fetch member profile from backend
        const response = await fetch(`http://localhost:5000/api/member/profile`, {
          method: 'GET',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${token}`
          }
        });

        let profileData = loggedInUser;

        if (response.ok) {
          const result = await response.json();
          const backendData = result.data || result;
          // Merge backend data with logged-in user info
          profileData = { ...loggedInUser, ...backendData };
        } else {
          console.warn('Could not fetch extended profile data, using basic user info');
        }

        // Populate form with profile data
        populateForm(profileData);
      } catch (error) {
        console.error('Error loading profile:', error);
        loadFallbackProfile();
      }
    }

    function populateForm(data) {
      document.getElementById('mName').value = data.name || data.fullName || '';
      document.getElementById('mEmail').value = data.email || '';
      document.getElementById('mRole').value = data.role || data.designation || '';
      document.getElementById('mCompany').value = data.company || data.currentCompany || '';
      document.getElementById('mExp').value = data.yearsOfExperience || data.experience || data.exp || '';
      document.getElementById('mBio').value = data.bio || data.about || '';

      const skills = Array.isArray(data.skills) ? data.skills.join(', ') : (data.skills || '');
      document.getElementById('mSkills').value = skills;

      document.getElementById('mLinkedin').value = data.linkedin || data.linkedinUrl || '';
      document.getElementById('mGithub').value = data.github || data.githubUrl || '';

      // Portfolio file display
      if (data.portfolio || data.portfolioUrl) {
        let fileName = 'Portfolio';
        const portfolioData = data.portfolio || data.portfolioUrl;

        if (typeof portfolioData === 'object' && portfolioData.filename) {
          fileName = portfolioData.filename;
        } else if (typeof portfolioData === 'string') {
          fileName = portfolioData.split('/').pop() || 'Portfolio';
        }

        const fileInput = document.getElementById('mPortfolio');
        if (fileInput.parentElement.querySelector('.portfolio-info')) {
          fileInput.parentElement.querySelector('.portfolio-info').remove();
        }
        const info = document.createElement('div');
        info.className = 'portfolio-info';
        info.style.cssText = 'margin-top: 8px; color: #22c55e; font-size: 12px; font-weight: 500;';
        info.innerHTML = `
        <span>âœ“ Current: ${fileName}</span>
        <button type="button" class="delete-portfolio-btn" onclick="deletePortfolio(event)">Delete File</button>
      `;
        fileInput.parentElement.appendChild(info);
      }
    }

    function loadFallbackProfile() {
      const data = JSON.parse(localStorage.getItem("memberProfile")) || {};
      populateForm(data);
    }

    // Store file data temporarily for download
    let pendingPortfolioFile = null;
    let portfolioToDelete = false;

    function deletePortfolio(e) {
      e.preventDefault();
      const fileInput = document.getElementById('mPortfolio');
      const portfolioInfo = fileInput.parentElement.querySelector('.portfolio-info');

      if (confirm('Are you sure you want to delete the uploaded portfolio?')) {
        portfolioInfo.remove();
        portfolioToDelete = true;
        showNotification('Portfolio marked for deletion', 'success');
      }
    }

    async function uploadPortfolioFile(file, token) {
      try {
        if (!file) return null;

        // Validate file type
        const allowedTypes = ['application/pdf', 'application/msword', 'application/vnd.openxmlformats-officedocument.wordprocessingml.document'];
        if (!allowedTypes.includes(file.type)) {
          showNotification('Invalid file type. Only PDF and Word documents are allowed.', 'error');
          return null;
        }

        // Validate file size (max 5MB)
        const maxSize = 5 * 1024 * 1024;
        if (file.size > maxSize) {
          showNotification('File is too large. Maximum size is 5MB.', 'error');
          return null;
        }

        // Convert file to base64 and store temporarily
        return new Promise((resolve) => {
          const reader = new FileReader();
          reader.onload = () => {
            // Store the file data temporarily for download
            pendingPortfolioFile = {
              filename: file.name,
              filedata: reader.result,
              filetype: file.type
            };
            // Return just metadata for backend storage
            resolve({
              filename: file.name,
              filetype: file.type
            });
          };
          reader.onerror = () => {
            showNotification('Error reading portfolio file.', 'error');
            resolve(null);
          };
          reader.readAsDataURL(file);
        });
      } catch (error) {
        console.error('Error preparing portfolio file:', error);
        showNotification('Failed to prepare portfolio file.', 'error');
        return null;
      }
    }

    async function updateProfile(profile) {
      try {
        const token = localStorage.getItem('token') || localStorage.getItem('accessToken');

        if (!token) {
          showNotification('Authentication error. Please log in again.', 'error');
          return false;
        }

        console.log('Sending profile update to backend:', profile);

        const response = await fetch(`http://localhost:5000/api/member/profile`, {
          method: 'PUT',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${token}`
          },
          body: JSON.stringify(profile)
        });

        console.log('Backend response status:', response.status);

        if (!response.ok) {
          const errorData = await response.json().catch(() => ({}));
          const errorMessage = errorData.message || `Failed to update profile: ${response.status}`;
          console.error('Backend error response:', { status: response.status, message: errorMessage, data: errorData });
          return false;
        }

        const result = await response.json();
        console.log('Backend success response:', result);
        return true;
      } catch (error) {
        console.error('Network/fetch error:', error);
        console.error('Error stack:', error.stack);
        return false;
      }
    }

    document.getElementById('memberProfileForm').onsubmit = async (e) => {
      e.preventDefault();

      const token = localStorage.getItem('token') || localStorage.getItem('accessToken');
      const portfolioFile = document.getElementById('mPortfolio').files[0];
      let portfolioData = null;

      // Prepare portfolio file if selected
      if (portfolioFile) {
        showNotification('Processing portfolio file...', 'info');
        portfolioData = await uploadPortfolioFile(portfolioFile, token);
        if (!portfolioData) {
          // Continue without portfolio if it fails
          console.warn('Portfolio file preparation failed, continuing without it');
        }
      }

      const profile = {
        name: document.getElementById('mName').value,
        email: document.getElementById('mEmail').value,
        role: document.getElementById('mRole').value,
        company: document.getElementById('mCompany').value,
        yearsExperience: document.getElementById('mExp').value ? parseInt(document.getElementById('mExp').value) : 0,
        bio: document.getElementById('mBio').value,
        linkedin: document.getElementById('mLinkedin').value,
        github: document.getElementById('mGithub').value,
        portfolio: portfolioToDelete ? null : (portfolioData || null), // null if deleting, new file if uploading
        skills: document.getElementById('mSkills').value.split(',').map(s => s.trim()).filter(s => s)
      };

      // Try to save to backend
      const backendResult = await updateProfile(profile);

      // Save pending portfolio file data to localStorage if we have one
      if (pendingPortfolioFile) {
        localStorage.setItem('portfolioFile', JSON.stringify(pendingPortfolioFile));
        pendingPortfolioFile = null;
      }

      // Also save to localStorage as backup
      const localProfile = {
        name: profile.name,
        email: profile.email,
        role: profile.role,
        company: profile.company,
        exp: profile.yearsExperience,
        bio: profile.bio,
        linkedin: profile.linkedin,
        github: profile.github,
        portfolio: profile.portfolio?.filename || '',
        skills: profile.skills.join(', ')
      };
      localStorage.setItem("memberProfile", JSON.stringify(localProfile));

      // Clear portfolio file from localStorage if deleted
      if (portfolioToDelete) {
        localStorage.removeItem('portfolioFile');
        portfolioToDelete = false;
      }

      if (backendResult) {
        showNotification('Profile updated successfully! ðŸŽ‰', 'success');
        setTimeout(() => {
          window.location.href = "my-profile.html?refresh=" + Date.now();
        }, 1500);
      } else {
        showNotification('âš ï¸ Could not sync with server, but your changes are saved locally. Please check your internet connection.', 'error');
        console.log('Check browser console for detailed error information');
        setTimeout(() => {
          window.location.href = "my-profile.html?refresh=" + Date.now();
        }, 3000);
      }
    }

    window.onload = loadProfile;

    function logout() {
      localStorage.removeItem("loggedIn");
      window.location.href = "../index.html";
    }
  </script>
  <script type="module" src="../assets/js/logout.js"></script>
</body>

</html>