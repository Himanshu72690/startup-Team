<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
  <meta http-equiv="Pragma" content="no-cache">
  <meta http-equiv="Expires" content="0">
  <script>
    (function(){
      // Immediate Auth Check
      const user = JSON.parse(localStorage.getItem("loggedInUser"));
      if(!user || user.role !== "founder"){
        window.location.replace("login.html");
      }
      // BFCache Check
      window.addEventListener('pageshow', function(event) {
        if (event.persisted) {
            window.location.reload();
        }
      });
    })();
  </script>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Founder Dashboard | StartupTeam</title>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <script src="https://unpkg.com/lucide@latest"></script>
  <style>
    /* EXACT CONSISTENT CSS THEME */
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: 'Poppins', sans-serif; background: #f8fafc; color: #1e293b; }
    .app { display: flex; min-height: 100vh; }

    /* SIDEBAR REFINED */
    .sidebar {
      width: 260px; background: #0f172a; color: #fff; padding: 30px 20px;
      display: flex; flex-direction: column; position: sticky; top: 0; height: 100vh;
      transition: width 0.3s ease;
    }
    
    .sidebar.collapsed {
      width: 80px;
      padding: 20px 10px;
    }

    .toggle-sidebar {
      background: none; border: none; color: #fff; cursor: pointer; 
      font-size: 20px; margin-bottom: 30px; display: flex; align-items: center; 
      justify-content: center; width: 40px; height: 40px;
      border-radius: 8px; transition: 0.3s;
    }
    .toggle-sidebar:hover { background: rgba(255,255,255,0.1); }

    .logo { font-size: 24px; font-weight: 700; margin-bottom: 40px; padding-left: 10px; transition: 0.3s; }
    .logo span { color: #6366f1; }

    .sidebar.collapsed .logo {
      font-size: 0;
      margin-bottom: 20px;
      padding-left: 0;
    }

    .sidebar a {
      display: flex; align-items: center; gap: 12px; color: #94a3b8; text-decoration: none;
      padding: 12px 15px; border-radius: 8px; margin-bottom: 5px; transition: 0.3s; font-size: 14px;
      white-space: nowrap;
    }

    .sidebar.collapsed a {
      padding: 12px;
      justify-content: center;
      gap: 0;
    }

    .sidebar.collapsed a span {
      display: none;
    }

    .sidebar a:hover, .sidebar a.active { background: rgba(255,255,255,0.05); color: #fff; }
    .sidebar a.active { background: #6366f1; color: white; }
    .logout-btn { margin-top: auto; background: #ef4444; color: white; border: none; padding: 12px; border-radius: 8px; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 8px; font-weight: 600; transition: 0.3s; white-space: nowrap; }

    .sidebar.collapsed .logout-btn {
      gap: 0;
      width: 40px;
      height: 40px;
      padding: 0;
    }

    .sidebar.collapsed .logout-btn span {
      display: none;
    }

    /* MAIN CONTENT */
    .main { flex: 1; padding: 40px; }
    .header-section { margin-bottom: 35px; }
    .header-section h2 { font-size: 28px; font-weight: 700; }

    /* STAT CARDS GRID */
    .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(240px, 1fr)); gap: 25px; margin-bottom: 40px; }
    
    .stat-card {
      background: #fff; padding: 25px; border-radius: 16px; border: 1px solid #f1f5f9;
      display: flex; align-items: center; gap: 20px; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.05);
      transition: 0.3s;
    }
    .stat-card:hover { transform: translateY(-5px); }

    .card-icon {
      width: 54px; height: 54px; border-radius: 12px;
      display: flex; align-items: center; justify-content: center;
    }
    .icon-blue { background: #eff6ff; color: #3b82f6; }
    .icon-purple { background: #f5f3ff; color: #8b5cf6; }
    .icon-orange { background: #fff7ed; color: #f97316; }

    .stat-info h3 { font-size: 24px; font-weight: 700; color: #0f172a; }
    .stat-info p { font-size: 13px; color: #64748b; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px; }

    /* RECENT ACTIVITY SECTION */
    .section-title { font-size: 18px; font-weight: 700; margin-bottom: 20px; color: #0f172a; }
    .activity-card { 
      background: #fff; padding: 30px; border-radius: 16px; border: 1px solid #f1f5f9; 
      box-shadow: 0 4px 6px -1px rgba(0,0,0,0.05);
    }
    
    .activity-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 25px; }

    .role-item {
      display: flex; justify-content: space-between; align-items: center;
      padding: 15px 0; border-bottom: 1px solid #f1f5f9;
    }
    .role-item:last-child { border-bottom: none; }
    .role-name { font-weight: 600; color: #1e293b; font-size: 15px; }
    .role-meta { font-size: 12px; color: #94a3b8; }
    .status-active { color: #22c55e; background: #f0fdf4; padding: 4px 10px; border-radius: 20px; font-size: 11px; font-weight: 700; }
  </style>
  <script type="module" src="../assets/js/logout.js"></script>
</head>
<body>

<div class="app">
  <aside class="sidebar">
    <button class="toggle-sidebar" onclick="toggleSidebar()"><i data-lucide="chevrons-left"></i></button>
    <div class="logo">Startup<span>Team</span></div>
    <nav>
      <a href="founder-dashboard.html" class="active"><i data-lucide="layout-dashboard"></i> <span>Dashboard</span></a>
      <a href="founder-profile.html"><i data-lucide="user"></i> <span>Founder Profile</span></a>
      <a href="startup-profile.html"><i data-lucide="rocket"></i> <span>Startup Profile</span></a>
      <a href="post-role.html"><i data-lucide="plus-circle"></i> <span>Post Role</span></a>
      <a href="roles-list.html"><i data-lucide="briefcase"></i> <span>Roles</span></a>
      <a href="members-requests.html"><i data-lucide="users"></i> <span>Member Requests</span></a>
      <a href="members-list.html"><i data-lucide="search"></i> <span>Explore Members</span></a>
      <a href="explore-startups.html"><i data-lucide="zap"></i> <span>Explore Startups</span></a>
    </nav>
    <button onclick="window.logoutUser()" class="logout-btn"><i data-lucide="log-out"></i> <span>Logout</span></button>
  </aside>

  <main class="main">
    <div class="header-section">
      <h2 id="welcomeText">Welcome back, Founder!</h2>
      <p style="color: #64748b; font-size: 14px;">Overview of your startup performance and hiring.</p>
    </div>

    <div class="stats-grid">
      <div class="stat-card">
        <div class="card-icon icon-blue"><i data-lucide="briefcase" size="24"></i></div>
        <div class="stat-info">
          <h3 id="totalRolesCount">0</h3>
          <p>Total Posted Roles</p>
        </div>
      </div>
      <div class="stat-card">
        <div class="card-icon icon-purple"><i data-lucide="users" size="24"></i></div>
        <div class="stat-info">
          <h3 id="totalRequestsCount">2</h3>
          <p>Requests</p>
        </div>
      </div>
      <div class="stat-card">
        <div class="card-icon icon-orange"><i data-lucide="zap" size="24"></i></div>
        <div class="stat-info">
          <h3>Active</h3>
          <p>Startup Status</p>
        </div>
      </div>
    </div>

    <div style="margin-top: 40px;">
      <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 25px; margin-bottom: 20px;">
        <div class="section-title">Posted Roles</div>
        <div class="section-title">Recent Member Requests</div>
      </div>
      <div class="activity-grid">
        <div class="activity-card" id="recentRolesList"></div>
        <div class="activity-card" id="recentRequestsList"></div>
      </div>
    </div>
  </main>
</div>

<script>
  lucide.createIcons();

  function toggleSidebar() {
    const sidebar = document.querySelector('.sidebar');
    const toggle = document.querySelector('.toggle-sidebar i');
    
    sidebar.classList.toggle('collapsed');
    
    toggle.setAttribute('data-lucide', sidebar.classList.contains('collapsed') ? 'chevrons-right' : 'chevrons-left');
    lucide.createIcons();
    
    localStorage.setItem('sidebarCollapsed', sidebar.classList.contains('collapsed'));
  }

  function restoreSidebarState() {
    const isCollapsed = localStorage.getItem('sidebarCollapsed') === 'true';
    if (isCollapsed) {
      document.querySelector('.sidebar').classList.add('collapsed');
      document.querySelector('.toggle-sidebar i').setAttribute('data-lucide', 'chevrons-right');
    }
  }

  window.onload = async () => {
    restoreSidebarState();
    lucide.createIcons();
    // Get user from localStorage
    const loggedInUser = JSON.parse(localStorage.getItem("loggedInUser"));
    console.log("=== DASHBOARD DEBUG ===");
    console.log("Logged in user from localStorage:", loggedInUser);
    console.log("localStorage keys:", Object.keys(localStorage));
    
    // Try to get name from different possible locations
    let userName = "Founder";
    if (loggedInUser?.name) {
      userName = loggedInUser.name;
    } else if (loggedInUser?.email) {
      // Fallback: use first part of email
      userName = loggedInUser.email.split('@')[0];
    }
    
    console.log("Display name:", userName);
    document.getElementById('welcomeText').innerText = `Welcome back, ${userName}!`;

    const token = localStorage.getItem('token');
    console.log("Token exists:", !!token);

    // Only try backend calls if token exists
    if (token) {
      try {
        const response = await fetch('http://localhost:5000/api/founder/profile', {
          headers: {
            'Authorization': `Bearer ${token}`
          }
        });
        
        if (response.ok) {
          const result = await response.json();
          console.log("Backend profile response:", result);
          
          const backendUserName = result.data?.userId?.name || userName;
          console.log("Backend user name:", backendUserName);
          document.getElementById('welcomeText').innerText = `Welcome back, ${backendUserName}!`;
          
          // Update localStorage with fresh data
          if (result.data?.userId?.name) {
            const updated = JSON.parse(localStorage.getItem("loggedInUser")) || {};
            updated.name = result.data.userId.name;
            localStorage.setItem("loggedInUser", JSON.stringify(updated));
          }
        }
      } catch (error) {
        console.error("Error fetching profile:", error);
      }
    }

    // 2. Fetch roles
    if (token) {
      try {
        const response = await fetch('http://localhost:5000/api/founder/roles', {
          headers: {
            'Authorization': `Bearer ${token}`
          }
        });
        
        if (response.ok) {
          const result = await response.json();
          const roles = result.data || [];
          document.getElementById('totalRolesCount').innerText = roles.length;

          const recentList = document.getElementById('recentRolesList');
          if (roles.length === 0) {
            recentList.innerHTML = `<p style="text-align:center; color:#94a3b8; font-size:14px;">No roles posted yet. Start hiring!</p>`;
          } else {
            recentList.innerHTML = roles.slice(-3).reverse().map(role => `
              <div class="role-item">
                <div>
                  <div class="role-name">${role.title}</div>
                  <div class="role-meta">${role.jobType} • ${role.experience}</div>
                </div>
                <span class="status-active">Live</span>
              </div>
            `).join('');
          }
          return;
        }
      } catch (error) {
        console.error("Error fetching roles:", error);
      }
    }

    // Fallback: use localStorage for roles
    const roles = JSON.parse(localStorage.getItem("startup_roles")) || [];
    document.getElementById('totalRolesCount').innerText = roles.length;

    const recentList = document.getElementById('recentRolesList');
    if (roles.length === 0) {
      recentList.innerHTML = `<p style="text-align:center; color:#94a3b8; font-size:14px;">No roles posted yet. Start hiring!</p>`;
    } else {
      recentList.innerHTML = roles.slice(-3).reverse().map(role => `
        <div class="role-item">
          <div>
            <div class="role-name">${role.title}</div>
            <div class="role-meta">${role.type} • ${role.exp}</div>
          </div>
          <span class="status-active">Live</span>
        </div>
      `).join('');
    }

    // 3. Fetch member requests
    if (token) {
      try {
        const response = await fetch('http://localhost:5000/api/founder/applications', {
          headers: {
            'Authorization': `Bearer ${token}`
          }
        });
        
        if (response.ok) {
          const result = await response.json();
          const requests = result.data || [];
          
          const requestList = document.getElementById('recentRequestsList');
          if (requests.length === 0) {
            requestList.innerHTML = `<p style="text-align:center; color:#94a3b8; font-size:14px;">No member requests yet.</p>`;
          } else {
            requestList.innerHTML = requests.slice(-3).reverse().map(req => `
              <div class="role-item">
                <div>
                  <div class="role-name">${req.memberId?.name || 'Member'}</div>
                  <div class="role-meta">${req.roleId?.title || 'Role'} • ${req.status}</div>
                </div>
                <span class="status-active">${req.status}</span>
              </div>
            `).join('');
          }
          return;
        }
      } catch (error) {
        console.error("Error fetching requests:", error);
      }
    }

    // Fallback: use localStorage for requests
    const requests = JSON.parse(localStorage.getItem("member_applications")) || [];
    const requestList = document.getElementById('recentRequestsList');
    if (requests.length === 0) {
      requestList.innerHTML = `<p style="text-align:center; color:#94a3b8; font-size:14px;">No member requests yet.</p>`;
    } else {
      requestList.innerHTML = requests.slice(-3).reverse().map(req => `
        <div class="role-item">
          <div>
            <div class="role-name">${req.memberName || 'Member'}</div>
            <div class="role-meta">${req.role || 'Role'} • ${req.status || 'Pending'}</div>
          </div>
          <span class="status-active">${req.status || 'Pending'}</span>
        </div>
      `).join('');
    }
  }

  /* function logout() {
    localStorage.removeItem("loggedIn");
    window.location.href = "../login.html";
  } */
</script>
  <script type="module" src="../assets/js/founder.js?v=2" defer></script>
</body>
</html>